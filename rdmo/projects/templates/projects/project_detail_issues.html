{% load i18n %}
{% load rules %}
{% load core_tags %}

{% has_perm 'projects.change_project_object' request.user project as can_change_project %}

{% if settings.PROJECT_ISSUES and tasks_available %}

<div id="project-issues">

    <h2>{% trans 'Tasks' %}</h2>

    {% include 'projects/project_detail_issues_help.html' %}

    {% if issues %}

        <table class="table">
            <thead>
                <th style="width: 10%">{% trans 'Task' %}</th>
                <th style="width: 50%">{% trans 'Description' %}</th>
                <th style="width: 15%">{% trans 'Time frame' %}</th>
                <th style="width: 15%">{% trans 'Status' %}</th>
                <th style="width: 10%" class="text-right">
                {% if can_change_project %}
                    <a href="{% url 'project_update_tasks' project.pk %}" title="{% trans 'Update project tasks.' %}">
                        <i class="fa fa-pencil"></i>
                    </a>
                {% endif %}
                </th>
            </thead>
           <tbody>
    {% for resolved_issue in issues %}
    <tr>
        <td>
            <a href="{% url 'issue' project.pk resolved_issue.issue.pk %}">
                {{ resolved_issue.issue.task.title|markdown }}
            </a>
        </td>
        <td>
            {{ resolved_issue.issue.task.text|markdown }}
            <ul>
                {% for condition in resolved_issue.conditions %}
                <li>
                    <strong>Condition:</strong> {{ condition.condition.relation_label }}<br>
                    <strong>Reason:</strong> {{ condition.reason }}<br>
                    {% if condition.trigger_question_url %}
                    <strong>Triggered by:</strong>
                    <a href="{{ condition.trigger_question_url }}">View Question</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </td>
        <td>
            {% for dates in resolved_issue.issue.dates %}
                {% if dates|length > 1 %}
                <p>{{ dates.0 | date:"DATE_FORMAT" }}<br /> - {{ dates.1 | date:"DATE_FORMAT" }}</p>
                {% else %}
                <p>{{ dates.0 | date:"DATE_FORMAT" }}</p>
                {% endif %}
            {% endfor %}
        </td>
        <td>{{ resolved_issue.issue.get_status_display }}</td>
        <td class="text-right">
            <a href="{% url 'issue' project.pk resolved_issue.issue.pk %}" class="fa fa-eye"
                title="{% trans 'Show task' %}">
            </a>
            <a href="{% url 'issue_update' project.pk resolved_issue.issue.pk %}" class="fa fa-pencil"
                title="{% trans 'Update task status' %}">
            </a>
            {% if settings.PROJECT_SEND_ISSUE %}
            <a href="{% url 'issue_send' project.pk resolved_issue.issue.pk %}" class="fa fa-paper-plane"
                title="{% trans 'Send task' %}">
            </a>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</tbody>

        </table>

    {% else %}

        {% if can_change_project %}
            <p class="project-update">
                <a href="{% url 'project_update_tasks' project.pk %}" title="{% trans 'Update project tasks.' %}">
                    <i class="fa fa-pencil"></i>
                </a>
            </p>
        {% endif %}

        {% if project.tasks.exists %}
            <p>
                {% trans 'No active tasks found.' %}
            </p>
        {% else %}
            <p>
                {% trans 'No tasks are configured for this project.' %}
            </p>
        {% endif %}

    {% endif %}

</div>

{% endif %}
